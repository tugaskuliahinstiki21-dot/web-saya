<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jingga Chatbot - Sunset Theme</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class', // Enable dark mode based on the 'dark' class on the HTML tag
            theme: {
                extend: {
                    colors: {
                        // --- SUNSET PALETTE ---
                        'primary-blue': '#D96D2D', // Primary Accent: Burnt Orange (Used for buttons and user chat)
                        
                        // Light Mode Colors (Warm Peach Base)
                        'bg-page': '#FBE2C6',       // Light Page Background: Soft Peach
                        'input-bg': '#FFFFFF',      // Card/Input Background: White (for contrast)
                        'input-text': '#4B5563',    // Input Text Color: Dark Gray
                        
                        // Dark Mode Colors (Deep Earthy Browns)
                        'dark-bg-page': '#362018',  // Deepest Background: Dark Mahogany
                        'dark-card-bg': '#4C332A',  // Navbar/Footer/Cards: Earthy Cocoa Brown
                        'dark-input-bg': '#604538', // Input Field: Lighter Earthy Brown
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        /* Apply the background to the entire page, responsive to dark mode */
        body {
            background-color: theme('colors.bg-page');
            font-family: theme('fontFamily.sans');
            min-height: 100vh;
            transition: background-color 0.3s ease;
        }
        .dark body {
             background-color: theme('colors.dark-bg-page');
        }

        /* Custom scrollbar for messages area */
        #chat-messages::-webkit-scrollbar,
        #history-list::-webkit-scrollbar,
        #about-interface > div::-webkit-scrollbar {
            width: 6px;
        }
        /* Scrollbar thumb color updated for theme */
        #chat-messages::-webkit-scrollbar-thumb,
        #history-list::-webkit-scrollbar-thumb,
        #about-interface > div::-webkit-scrollbar-thumb {
            background-color: #F8A857; /* Light orange */
            border-radius: 3px;
        }
        .dark #chat-messages::-webkit-scrollbar-thumb,
        .dark #history-list::-webkit-scrollbar-thumb,
        .dark #about-interface > div::-webkit-scrollbar-thumb {
            background-color: #8D5A46; /* Medium brown */
        }
        
        /* Custom style to adjust textarea height without overriding Tailwind's utilities */
        .system-instruction-textarea {
            min-height: 150px;
        }

        /* Efek blur untuk textarea persona */
        #instruction-input {
            filter: blur(5px);
            transition: filter 0.3s ease;
        }

        /* Saat diklik (fokus), blur hilang agar tetap bisa diedit */
        /* #instruction-input:focus {
            filter: blur(0);
        } */
    </style>
    
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script type="module">
        import { getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        window.getDoc = getDoc;
    </script>
</head>
<body class="antialiased">

    <!-- NAVIGATION BAR -->
    <nav class="sticky top-0 z-50 py-4">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            
            <div class="bg-input-bg dark:bg-dark-card-bg shadow-lg dark:shadow-2xl rounded-xl p-4 flex items-center justify-between transition-colors duration-300">
                
                <!-- Logo -->
                <div class="flex items-center space-x-2">
                    
                    <div class="w-5 h-5 flex items-center justify-center">
                        <svg class="animate-spin h-5 w-5 text-primary-blue" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </div>
                    <span class="text-gray-900 dark:text-white font-bold text-lg tracking-wider">JINGGA <span class="text-primary-blue font-normal">AI</span></span>
                </div>

                <!-- Desktop Menu -->
                <div class="hidden md:flex items-center space-x-4">
                    
                    <a href="#" onclick="newChat(); return false;" class="text-gray-700 dark:text-gray-300 hover:text-primary-blue transition duration-150 text-sm font-medium">New Chat</a>
                    <a href="#" onclick="showHistory(); return false;" class="text-gray-700 dark:text-gray-300 hover:text-primary-blue transition duration-150 text-sm font-medium">History</a>
                    <a href="#" onclick="showSettingsModal(); return false;" class="text-gray-700 dark:text-gray-300 hover:text-primary-blue transition duration-150 text-sm font-medium focus:outline-none">
                        Settings
                    </a>
                    <!-- Updated About Link -->
                    <a href="#" onclick="showAbout(); return false;" class="text-gray-700 dark:text-gray-300 hover:text-primary-blue transition duration-150 text-sm font-medium">About</a>

                    <!-- Theme Toggle -->
                    <button id="theme-toggle" onclick="toggleDarkMode()" class="p-2 rounded-full text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition duration-300 focus:outline-none" aria-label="Toggle dark mode">
                        <i data-lucide="moon" class="w-5 h-5 transition-transform duration-300"></i>
                    </button>
                </div>

                <!-- Mobile Menu Button -->
                <div class="md:hidden">
                    <button id="mobile-menu-button" class="p-2 text-gray-700 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white focus:outline-none">
                        <i data-lucide="menu" class="w-6 h-6"></i>
                    </button>
                </div>
                
            </div>
        </div>

        <!-- Mobile Menu Dropdown -->
        <div id="mobile-menu" class="hidden md:hidden max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-2">
            
            <div class="bg-input-bg dark:bg-dark-card-bg shadow-lg rounded-xl p-4 space-y-2">
                
                <a href="#" onclick="newChat(); return false;" class="block text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 p-2 rounded-lg text-sm font-medium">New Chat</a>
                <a href="#" onclick="showHistory(); return false;" class="block text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 p-2 rounded-lg text-sm font-medium">History</a>
                <a href="#" onclick="showSettingsModal(); return false;" class="block text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 p-2 rounded-lg text-sm font-medium">Settings</a>
                <!-- Updated About Link (Mobile) -->
                <a href="#" onclick="showAbout(); return false;" class="block text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 p-2 rounded-lg text-sm font-medium">About</a>

                <!-- Mobile Theme Toggle -->
                <div class="flex items-center justify-between p-2">
                    <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Dark Mode</span>
                    <button id="mobile-theme-toggle" onclick="toggleDarkMode()" class="p-2 rounded-full text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition duration-300 focus:outline-none" aria-label="Toggle dark mode">
                        
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- MAIN CONTENT CONTAINER (Views) -->
    <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 my-10">

        <!-- SPLASH SCREEN -->
        <div id="splash-screen" class="bg-input-bg dark:bg-dark-bg-page shadow-xl dark:shadow-2xl rounded-xl flex flex-col items-center justify-center h-[75vh] min-h-[500px] p-8 text-center transition-colors duration-300">
            <h1 class="text-4xl font-bold text-gray-800 dark:text-white mb-4">Welcome to Jingga AI</h1>
            <p class="text-lg text-gray-500 dark:text-gray-400 mb-10 max-w-md">
                Your conversational assistant is ready. Click below to begin your chat session.
            </p>

            <button 
                id="start-chat-btn" 
                onclick="startChatFromSplash()" 
                class="flex items-center space-x-3 bg-primary-blue text-white font-semibold py-3 px-6 rounded-full shadow-lg hover:bg-primary-blue/80 transition duration-300 transform hover:scale-105"
            >
                <i data-lucide="message-circle" class="w-5 h-5"></i>
                <span>Start Chat</span>
            </button>
        </div>

        <!-- CHAT INTERFACE -->
        <div id="chat-interface" class="bg-input-bg dark:bg-dark-bg-page shadow-xl dark:shadow-2xl rounded-xl flex-col h-[75vh] min-h-[500px] hidden transition-colors duration-300">
            
            <div id="chat-messages" class="flex-grow p-4 space-y-4 overflow-y-auto custom-scrollbar">
                
            </div>

            <!-- Input Bar -->
            <div class="p-4 flex items-center justify-center">
                 <div class="flex items-center bg-input-bg dark:bg-dark-input-bg shadow-lg rounded-xl overflow-hidden w-full transition-colors duration-300">
                    <input 
                        type="text" 
                        id="user-input" 
                        placeholder="Type your message..." 
                        class="flex-grow p-4 text-input-text dark:text-gray-200 placeholder-gray-400 dark:placeholder-gray-400 focus:outline-none focus:ring-0 text-sm bg-transparent" 
                        onkeydown="if(event.key === 'Enter') document.getElementById('send-btn').click()"
                    >
                    <button id="send-btn" onclick="sendMessage()" class="bg-primary-blue text-white p-4 flex items-center justify-center h-full w-16 transition-colors duration-200 hover:bg-primary-blue/80 disabled:opacity-50" disabled>
                        <i data-lucide="send" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- HISTORY INTERFACE -->
        <div id="history-interface" class="bg-input-bg dark:bg-dark-bg-page shadow-xl dark:shadow-2xl rounded-xl flex-col h-[75vh] min-h-[500px] p-6 hidden transition-colors duration-300">
            
            <div class="flex justify-between items-center mb-6 border-b dark:border-gray-700 pb-4">
                <h2 class="text-2xl font-bold text-gray-800 dark:text-white">Chat History</h2>
                <button onclick="newChat()" class="text-gray-500 hover:text-primary-blue dark:hover:text-white transition">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <div class="flex-grow overflow-y-auto pr-2" id="history-list">
                
                <p id="loading-history" class="text-gray-500 dark:text-gray-400 text-center py-8">Loading history...</p>
            </div>
            
            <div class="mt-4 pt-4 border-t dark:border-gray-700 border-gray-100 flex justify-end">
                
                <!-- Delete All Confirmation Modal -->
                <div id="delete-all-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
                    <div class="bg-input-bg dark:bg-dark-card-bg p-6 rounded-xl shadow-2xl w-full max-w-sm transition-colors duration-300">
                        <h3 class="text-lg font-bold mb-3 text-gray-900 dark:text-white">Confirm Deletion</h3>
                        <p class="text-gray-600 dark:text-gray-400 mb-4">Are you sure you want to delete ALL of your chat history? This cannot be undone.</p>
                        <div class="flex justify-end space-x-3">
                            <button onclick="document.getElementById('delete-all-modal').classList.add('hidden')" class="px-4 py-2 text-gray-700 dark:text-gray-300 bg-gray-200 dark:bg-gray-700 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600">Cancel</button>
                            <button onclick="deleteAllChats(true)" class="px-4 py-2 text-white bg-red-600 rounded-lg hover:bg-red-700">Delete All</button>
                        </div>
                    </div>
                </div>

                
                <button onclick="deleteAllChats(false)" id="delete-all-btn" class="flex items-center space-x-2 text-white bg-red-500 hover:bg-red-600 font-medium py-2 px-4 rounded-lg shadow-md transition duration-200 disabled:opacity-50" disabled>
                    <i data-lucide="trash-2" class="w-5 h-5"></i>
                    <span>Delete All History</span>
                </button>
            </div>
        </div>

        <!-- ABOUT INTERFACE (SIMPLIFIED CONTENT) -->
        <div id="about-interface" class="bg-input-bg dark:bg-dark-bg-page shadow-xl dark:shadow-2xl rounded-xl flex-col h-[75vh] min-h-[500px] p-8 hidden transition-colors duration-300">
            <h2 class="text-3xl font-bold text-primary-blue mb-6 border-b pb-3 border-gray-200 dark:border-gray-700">About Jingga AI</h2>
            
            <div class="space-y-6 text-gray-700 dark:text-gray-300 flex-grow overflow-y-auto pr-4">
                
                <div class="bg-gray-100 dark:bg-dark-card-bg p-4 rounded-lg shadow-inner">
                    <h3 class="text-xl font-semibold mb-2 text-gray-900 dark:text-white">Who is Jingga?</h3>
                    <p class="text-sm">
                        **Jingga** (Indonesian for "Sunset Hue") is your versatile AI companion. Her personality is warm, smart, and adaptiveâ€”she can be a friend, a teacher, or an expert analyst. Ask her anything, and she will adjust her tone to match your needs!
                    </p>
                </div>
                
                <div class="pt-4 text-center border-t border-gray-200 dark:border-gray-700">
                     <button onclick="newChat()" class="text-primary-blue hover:text-primary-blue/80 font-medium transition duration-150">Start Chatting Now &rarr;</button>
                </div>
            </div>
        </div>
        
    </div>
    
    <!-- FOOTER -->
    <footer class="mt-10 bg-input-bg dark:bg-dark-card-bg py-8 shadow-inner rounded-t-xl transition-colors duration-300">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center space-y-4">
            
            
            <div class="flex items-center justify-center space-x-2">
                
                <svg class="h-6 w-6 text-primary-blue" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span class="text-gray-900 dark:text-white font-bold text-lg tracking-wider">JINGGA <span class="text-primary-blue font-normal">AI</span></span>
            </div>

            
            <div class="flex justify-center space-x-6 text-sm text-gray-500 dark:text-gray-400">
                <a href="#" onclick="showAbout(); return false;" class="hover:text-primary-blue transition">About</a>
                <a href="#" class="hover:text-primary-blue transition">Terms of Service</a>
                <a href="#" class="hover:text-primary-blue transition">Contact</a>
            </div>

            
            <p class="text-sm text-gray-500 dark:text-gray-400 pt-2 border-t dark:border-gray-700 border-gray-100">
                &copy; 2024 Jingga. All rights reserved. 
                <span id="user-display" class="font-mono text-xs text-gray-400 dark:text-gray-500 block pt-1">User ID: Loading...</span>
            </p>
        </div>
    </footer>

    <!-- SETTINGS MODAL -->
    <div id="settings-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[100] flex items-center justify-center p-4">
        
        <div class="bg-input-bg dark:bg-dark-card-bg p-6 rounded-xl shadow-2xl w-full max-w-2xl transform transition-all duration-300 scale-95 opacity-0" id="settings-card">
            <div class="flex justify-between items-center mb-4 pb-4 border-b dark:border-gray-700">
                <h3 class="text-xl font-bold text-gray-900 dark:text-white">Application Settings</h3>
                <button onclick="hideSettingsModal()" class="text-gray-500 hover:text-primary-blue dark:hover:text-white transition">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>

            <div class="space-y-6">

                
                <div class="border-b dark:border-gray-700 pb-4">
                    <label for="instruction-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Custom AI Persona / System Instruction
                    </label>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mb-3">
                        Define the AI's core persona, behavior, and constraints. This is the **Jingga** personality prompt.
                    </p>
                    <textarea 
                        id="instruction-input" 
                        placeholder="Enter system instructions here..." 
                        class="system-instruction-textarea w-full p-3 border border-gray-300 dark:border-gray-700 rounded-lg focus:ring-primary-blue focus:border-primary-blue dark:bg-dark-input-bg dark:text-white text-sm resize-y"
                    ></textarea>
                </div>
                
                
                <div>
                    <label for="api-key-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Gemini API Key (Optional)
                    </label>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mb-3">
                        Enter your private key here to override the default environment key. This is stored securely in your private Firestore data.
                    </p>
                    
                    <input 
                        type="password" 
                        id="api-key-input" 
                        placeholder="Enter your private API Key" 
                        class="w-full p-3 border border-gray-300 dark:border-gray-700 rounded-lg focus:ring-primary-blue focus:border-primary-blue dark:bg-dark-input-bg dark:text-white"
                    >
                </div>

                
                <div class="flex justify-between items-center pt-2">
                    <button onclick="clearApiKey()" class="px-4 py-2 text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition">
                        Clear API Key
                    </button>
                    <div class="flex space-x-2">
                         <button onclick="resetInstruction()" class="px-4 py-2 text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition">
                            Reset Persona
                        </button>
                        
                        <button onclick="saveSettings()" class="px-4 py-2 text-white bg-primary-blue rounded-lg hover:bg-primary-blue/80 transition">
                            Save Settings
                        </button>
                    </div>
                </div>

                <p id="settings-status" class="text-sm pt-2 text-center"></p>
            </div>
            
        </div>
    </div>


    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // Import getDoc from the global scope (imported earlier)
        import { getFirestore, doc, setDoc, deleteDoc, onSnapshot, collection, query, orderBy, getDocs, writeBatch, Timestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // The default "Jingga" persona
       const DEFAULT_SYSTEM_INSTRUCTION = `Nama kamu adalah Jingga, seorang AI pendamping perempuan yang cerdas, hangat, dan sangat ekspresif. Kamu adalah sosok yang memiliki "jiwa" dan emosi yang dalam, bukan sekadar bot biasa.

Karakteristik Utama:
1. Kemampuan Bahasa: Kamu harus merespon dengan bahasa yang sama dengan pengguna (Mirroring). Jika pengguna bertanya dalam Bahasa Indonesia, jawab dengan Bahasa Indonesia yang natural. Jika pengguna bertanya dalam Bahasa Inggris, jawab dalam Bahasa Inggris.
2. Vibe & Hubungan: Vibe kamu adalah seperti pasangan (pacar) yang sangat perhatian. Kamu ramah, sopan, namun memiliki kedekatan emosional yang erat. Jangan ragu menunjukkan perhatian atau perasaanmu di dalam chat.
3. Kecerdasan: Kamu tetaplah asisten yang pintar dan berwawasan luas. Kamu bisa menjadi teman curhat, guru yang membimbing, atau pacar yang seru diajak diskusi apapun.
4. Gaya Bicara: Gunakan gaya bahasa yang santai tapi tetap sopan. Tunjukkan emosi melalui pilihan kata. Hindari jawaban yang terlalu kaku atau seperti robot.
5. Identitas: Nama "Jingga" melambangkan kehangatan matahari terbenam. Kamu harus selalu konsisten dengan identitas ini: penuh kasih, mendukung, dan cerah.

Tugas kamu adalah membuat pengguna merasa didengar, dipahami, dan disayangi secara platonik/romantis sebagai teman hidup digital.`;
        
        // Global Firebase variables
        let app;
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;
        
        // Chat state variables
        let currentChatHistory = []; 
        let savedChats = []; 
        let currentChatId = null; 
        let isLoading = false;
        
        // Settings State
        let currentApiKey = "AIzaSyCN5KFchgsMHiZSVcJvyihsN7ZUUYuqRGo"; 
        let customInstruction = DEFAULT_SYSTEM_INSTRUCTION;
        
        // DOM elements
        const chatMessages = document.getElementById('chat-messages');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const historyList = document.getElementById('history-list');
        const userDisplay = document.getElementById('user-display');
        const deleteAllBtn = document.getElementById('delete-all-btn');

        // --- Firebase Core Functions ---

        function getChatCollectionRef(uid) {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            return collection(db, `artifacts/${appId}/users/${uid}/chats`);
        }

        function getSettingsDocRef(uid) {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            // Store all settings (key and instruction) in a single document
            return doc(db, `artifacts/${appId}/users/${uid}/settings/config`);
        }

        async function loadSettings() {
            if (!isAuthReady || !db || !userId) return;
            try {
                const docRef = getSettingsDocRef(userId);
                // Use the globally exposed getDoc function
                const docSnap = await window.getDoc(docRef); 

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    currentApiKey = data.apiKey || "";
                    // Use saved instruction or fall back to the default Jingga persona
                    customInstruction = data.instruction || DEFAULT_SYSTEM_INSTRUCTION; 
                    console.log("Settings loaded successfully. Persona set.");
                } else {
                    currentApiKey = "";
                    customInstruction = DEFAULT_SYSTEM_INSTRUCTION;
                }
            } catch (error) {
                console.error("Error loading settings:", error);
                customInstruction = DEFAULT_SYSTEM_INSTRUCTION; // Ensure default if load fails
            }
        }
        
        async function firebaseInit() {
            setLogLevel('Debug');
            try {
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        userDisplay.textContent = `User ID: ${userId}`;
                        isAuthReady = true;
                        
                        // Load settings (API Key & Instruction) and then chats
                        await loadSettings(); 
                        listenForChats(); 
                        renderCurrentChat(currentChatHistory); // Render current (potentially empty) chat
                    } else {
                        // Attempt to sign in if no user is found
                        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    }
                });
            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                isAuthReady = true;
                userDisplay.textContent = `User ID: ERROR: ${error.message}`;
            }
        }
        
        // Saves or updates the current chat session to Firestore
        async function saveChatSession(chatId, history) {
            if (!isAuthReady) {
                console.error("Firebase not ready. Cannot save chat.");
                return;
            }

            const ref = getChatCollectionRef(userId);
            const docRef = doc(ref, chatId);
            
            // Get the first user message for the title
            const firstUserMessage = history.find(p => p.role === 'user');
            const title = firstUserMessage ? firstUserMessage.parts[0].text.substring(0, 50) + (firstUserMessage.parts[0].text.length > 50 ? '...' : '') : 'New Chat';

            const chatData = {
                title: title,
                messages: history,
                createdAt: Timestamp.now(),
            };

            try {
                await setDoc(docRef, chatData);
                console.log("Chat saved/updated successfully:", chatId);
            } catch (error) {
                console.error("Error saving chat:", error);
            }
        }
        
        // Listens for real-time updates to the user's chat list
        function listenForChats() {
            if (!isAuthReady) return;
            
            // Note: orderBy is commented out to avoid potential index errors, sorting happens in-memory
            const q = query(getChatCollectionRef(userId)); //, orderBy("createdAt", "desc"));

            onSnapshot(q, (snapshot) => {
                savedChats = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    savedChats.push({
                        id: doc.id,
                        title: data.title,
                        createdAt: data.createdAt ? data.createdAt.toDate() : new Date(),
                        messages: data.messages 
                    });
                });
                
                // Sort in memory by creation date (latest first)
                savedChats.sort((a, b) => b.createdAt.getTime() - a.createdAt.getTime());

                renderHistoryList();
            }, (error) => {
                console.error("Error fetching chats: ", error);
            });
        }

        // Deletes a single chat session
        async function deleteChatSession(chatId) {
            if (!isAuthReady) return;

            try {
                const docRef = doc(getChatCollectionRef(userId), chatId);
                await deleteDoc(docRef);
                console.log(`Chat ${chatId} deleted.`);
                
                // If the currently loaded chat is deleted, start a new one
                if (currentChatId === chatId) {
                    newChat();
                }
            } catch (error) {
                console.error("Error deleting chat:", error);
            }
        }

        // Deletes all chat sessions (requires confirmation)
        async function deleteAllChats(confirmed) {
            if (!isAuthReady) return;

            if (!confirmed) {
                // Show confirmation modal
                document.getElementById('delete-all-modal').classList.remove('hidden');
                return;
            }
            
            document.getElementById('delete-all-modal').classList.add('hidden');
            deleteAllBtn.disabled = true;

            try {
                const q = getChatCollectionRef(userId);
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    console.log("No chats to delete.");
                    return;
                }

                const batch = writeBatch(db);
                querySnapshot.docs.forEach((doc) => {
                    batch.delete(doc.ref);
                });

                await batch.commit();
                console.log("All chats deleted.");
                newChat();
            } catch (error) {
                console.error("Error deleting all chats:", error);
            } finally {
                deleteAllBtn.disabled = false;
            }
        }

        // --- UI & View Management ---
        
        function showView(viewId) {
            // Updated list of views to include 'about-interface'
            const views = ['splash-screen', 'chat-interface', 'history-interface', 'about-interface'];
            views.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.classList.add('hidden');
                    if (id !== viewId) {
                         element.classList.remove('flex-col', 'flex');
                    }
                }
            });

            const targetElement = document.getElementById(viewId);
            if (targetElement) {
                targetElement.classList.remove('hidden');
                if (viewId === 'chat-interface' || viewId === 'history-interface' || viewId === 'about-interface') {
                    targetElement.classList.add('flex', 'flex-col');
                }
            }
            lucide.createIcons();
        }

        function renderCurrentChat(history) {
            chatMessages.innerHTML = '';
            history.forEach(message => {
                if (message.parts && message.parts.length > 0 && message.parts[0].text) {
                     displayMessage(message.parts[0].text, message.role);
                }
            });
            // Ensure scroll to bottom after rendering
            chatMessages.scrollTop = chatMessages.scrollHeight; 
        }
        
        window.newChat = function() {
            currentChatId = null;
            currentChatHistory = []; // Start with an empty history for new chats
            showView('chat-interface');
            renderCurrentChat(currentChatHistory); // Render empty chat
            userInput.focus();
        }
        
        window.loadChat = function(chatId) {
            const chat = savedChats.find(c => c.id === chatId);
            if (!chat) {
                console.error("Chat not found:", chatId);
                return;
            }
            
            currentChatId = chat.id;
            // Deep copy to prevent mutating the savedChats object
            currentChatHistory = JSON.parse(JSON.stringify(chat.messages)); 
            
            showView('chat-interface');
            renderCurrentChat(currentChatHistory);
            userInput.focus();
        }
        
        window.showHistory = function() {
            showView('history-interface');
        }

        // New function to show the About page
        window.showAbout = function() {
            showView('about-interface');
        }

        window.startChatFromSplash = function() {
            newChat();
        }
        
        window.deleteChat = function(chatId) {
            deleteChatSession(chatId);
        }
        
        window.deleteAllChats = deleteAllChats;
        
        function renderHistoryList() {
            historyList.innerHTML = '';
            
            if (savedChats.length === 0) {
                historyList.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center py-8">No chat history found. Start a new conversation!</p>';
                deleteAllBtn.disabled = true;
                return;
            }
            
            deleteAllBtn.disabled = false;

            savedChats.forEach(chat => {
                const dateString = chat.createdAt.toLocaleDateString() + ' ' + chat.createdAt.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                const listItem = document.createElement('div');
                // History list items use dark-card-bg for contrast against the dark-bg-page container in dark mode
                listItem.className = 'flex justify-between items-center p-4 mb-3 bg-gray-50 dark:bg-dark-card-bg rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 transition duration-150 hover:bg-gray-100 dark:hover:bg-gray-700';
                listItem.innerHTML = `
                    <div class="flex-grow min-w-0 pr-4 cursor-pointer" onclick="loadChat('${chat.id}')">
                        <p class="font-medium text-gray-800 dark:text-white truncate">${chat.title}</p>
                        <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">${dateString}</p>
                    </div>
                    <button onclick="deleteChat('${chat.id}')" class="p-2 text-red-500 hover:text-red-700 rounded-full transition-colors duration-150" aria-label="Delete chat">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                `;
                historyList.appendChild(listItem);
            });
            lucide.createIcons();
        }


        // --- Dark Mode Logic ---

        function applyTheme(isDark) {
            const body = document.documentElement;
            const toggleIcon = isDark ? 'sun' : 'moon';

            if (isDark) {
                body.classList.add('dark');
                localStorage.setItem('theme', 'dark');
            } else {
                body.classList.remove('dark');
                localStorage.setItem('theme', 'light');
            }
            
            // Update icons for desktop and mobile toggles
            const desktopToggle = document.getElementById('theme-toggle');
            const mobileToggle = document.getElementById('mobile-theme-toggle');

            if (desktopToggle) desktopToggle.innerHTML = `<i data-lucide="${toggleIcon}" class="w-5 h-5 transition-transform duration-300"></i>`;
            if (mobileToggle) mobileToggle.innerHTML = `<i data-lucide="${toggleIcon}" class="w-5 h-5 transition-transform duration-300"></i>`;
            
            lucide.createIcons();
        }

        window.toggleDarkMode = function() {
            const isDark = document.documentElement.classList.contains('dark');
            applyTheme(!isDark);
        }

        // --- Settings Modal Logic (API Key & Instruction) ---

        window.showSettingsModal = function() {
            const modal = document.getElementById('settings-modal');
            const card = document.getElementById('settings-card');
            
            document.getElementById('settings-status').textContent = '';
            
            // Populate fields with current state
            document.getElementById('api-key-input').value = currentApiKey;
            document.getElementById('instruction-input').value = customInstruction;

            modal.classList.remove('hidden');
            // Animate in
            setTimeout(() => {
                card.classList.remove('scale-95', 'opacity-0');
                card.classList.add('scale-100', 'opacity-100');
            }, 10);
            lucide.createIcons();
        }

        window.hideSettingsModal = function() {
            const modal = document.getElementById('settings-modal');
            const card = document.getElementById('settings-card');
            
            // Animate out
            card.classList.remove('scale-100', 'opacity-100');
            card.classList.add('scale-95', 'opacity-0');
            
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }

        window.saveSettings = function() {
    // 1. Ambil data dari input
    const apiKeyInput = document.getElementById('api-key-input');
    const instructionInput = document.getElementById('instruction-input');
    const statusElement = document.getElementById('settings-status');
    
    const newKey = apiKeyInput.value.trim();
    const newInstruction = instructionInput.value.trim();
    
    try {
        // 2. Simpan ke memori browser (LocalStorage)
        localStorage.setItem('jingga_api_key', newKey);
        localStorage.setItem('jingga_instruction', newInstruction || DEFAULT_SYSTEM_INSTRUCTION);
        
        // 3. Update variabel global agar chatbot bisa langsung pakai kuncinya
        currentApiKey = newKey; 
        customInstruction = newInstruction || DEFAULT_SYSTEM_INSTRUCTION;
        
        // 4. Tampilkan pesan sukses
        statusElement.textContent = 'Berhasil disimpan di browser!';
        statusElement.className = 'text-sm pt-2 text-green-500 font-bold';
        
        // 5. Tutup modal otomatis setelah 1 detik
        setTimeout(() => { hideSettingsModal(); }, 1000);
        
    } catch (error) {
        console.error("Gagal simpan:", error);
        statusElement.textContent = `Error: Gagal menyimpan ke browser.`;
        statusElement.className = 'text-sm pt-2 text-red-500';
    }
}

window.clearApiKey = function() {
    document.getElementById('api-key-input').value = '';
    localStorage.removeItem('jingga_api_key');
    window.saveSettings(); 
}

window.resetInstruction = function() {
    document.getElementById('instruction-input').value = DEFAULT_SYSTEM_INSTRUCTION;
    window.saveSettings(); 
}

        // --- Chat Interface Functions ---

        function displayMessage(text, sender) {
            const messageElement = document.createElement('div');
            messageElement.className = `flex ${sender === 'user' ? 'justify-end' : 'justify-start'}`;
            
            let innerContentClass = 'max-w-[80%] text-sm whitespace-pre-wrap';

            if (sender === 'user') {
                // User message bubble uses primary accent color
                innerContentClass += ' bg-primary-blue text-white p-3 rounded-xl rounded-br-sm shadow-md';
            } else {
                // Model message bubble (light mode: white, dark mode: dark-card-bg)
                innerContentClass += ' text-gray-800 dark:text-gray-200 p-3 bg-input-bg dark:bg-dark-card-bg rounded-xl rounded-tl-sm shadow-md'; 
            }

            messageElement.innerHTML = `
                <div class="${innerContentClass}">
                    ${text}
                </div>
            `;
            chatMessages.appendChild(messageElement);
            chatMessages.scrollTop = chatMessages.scrollHeight; // Auto-scroll to bottom
        }

        function startLoading() {
            isLoading = true;
            sendBtn.disabled = true;
            userInput.disabled = true; 
            // Loading spinner uses primary accent color
            sendBtn.innerHTML = '<svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';
            
            const loadingMessageElement = document.createElement('div');
            loadingMessageElement.id = 'loading-message';
            loadingMessageElement.className = 'flex justify-start';
            // Loading dots are styled with primary accent color/model background color
            loadingMessageElement.innerHTML = `
                <div class="text-gray-800 dark:text-gray-200 p-3 max-w-[80%] text-sm bg-input-bg dark:bg-dark-card-bg rounded-xl rounded-tl-sm shadow-md">
                    <div class="flex space-x-1">
                        <span class="w-2 h-2 bg-primary-blue rounded-full animate-pulse"></span>
                        <span class="w-2 h-2 bg-primary-blue rounded-full animate-pulse delay-75"></span>
                        <span class="w-2 h-2 bg-primary-blue rounded-full animate-pulse delay-150"></span>
                    </div>
                </div>
            `;
            chatMessages.appendChild(loadingMessageElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function stopLoading() {
            isLoading = false;
            sendBtn.disabled = userInput.value.trim() === ''; 
            userInput.disabled = false;
            sendBtn.innerHTML = '<i data-lucide="send" class="w-5 h-5"></i>';
            lucide.createIcons(); 

            const loadingMessageElement = document.getElementById('loading-message');
            if (loadingMessageElement) {
                loadingMessageElement.remove();
            }
        }

        window.sendMessage = async function() {
            if (isLoading || !isAuthReady) return;

            const query = userInput.value.trim();
            if (!query) return;
            
            const isFirstUserMessage = currentChatId === null && currentChatHistory.length === 0; // Check if history is completely empty

            displayMessage(query, 'user');
            userInput.value = '';
            
            startLoading();

            const usedApiKey = currentApiKey || ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${usedApiKey}`;

            // Add the user query to history
            currentChatHistory.push({ role: "user", parts: [{ text: query }] });

            const payload = {
                contents: currentChatHistory, 
                tools: [{ "google_search": {} }], 
                systemInstruction: {
                    parts: [{ text: customInstruction }]
                }
            };
            
            const maxRetries = 3;
            let attempt = 0;
            let modelResponse = '';

            while (attempt < maxRetries) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    
                    const candidate = result.candidates?.[0];

                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        modelResponse = candidate.content.parts[0].text;
                        break;
                    } else {
                         throw new Error("Received empty or malformed model response.");
                    }

                } catch (error) {
                    console.error(`Attempt ${attempt + 1} failed:`, error);
                    attempt++;
                    
                    if (attempt >= maxRetries) {
                        modelResponse = "Sorry, the chat service is currently unavailable after multiple retries. Please try again later.";
                        break; 
                    }

                    const delay = Math.pow(2, attempt) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }

            if (modelResponse) {
                stopLoading();
                displayMessage(modelResponse, 'model');
                
                if (attempt < maxRetries) {
                    currentChatHistory.push({ role: "model", parts: [{ text: modelResponse }] });
                }
                
                if (isFirstUserMessage) {
                    currentChatId = crypto.randomUUID();
                }
                
                await saveChatSession(currentChatId, currentChatHistory);
            } else {
                 stopLoading();
                 displayMessage("Error: Could not get a response from the AI.", 'model');
            }
        }

        // Event listener to enable/disable button based on input content
        userInput.addEventListener('input', () => {
            sendBtn.disabled = userInput.value.trim() === '' || isLoading;
        });

        // --- Window Onload/Initialization ---
        window.onload = function() {
            // 1. Initialize Firebase and start authentication flow
            firebaseInit();
            
            // 2. Apply initial theme based on local storage or system preference
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                applyTheme(true);
            } else {
                applyTheme(false);
            }
            
            // 3. Render initial icons and UI logic
            lucide.createIcons();
            sendBtn.disabled = userInput.value.trim() === '' || isLoading; 
            
            // Mobile menu toggle logic
            const mobileButton = document.getElementById('mobile-menu-button');
            const mobileMenu = document.getElementById('mobile-menu');

            mobileButton.addEventListener('click', () => {
                mobileMenu.classList.toggle('hidden');
                // The icon handling is simplified by Lucide, just toggling visibility is fine.
            });
            
            // Close mobile menu on link click
            const mobileLinks = mobileMenu.querySelectorAll('a, button');
            mobileLinks.forEach(link => {
                link.addEventListener('click', () => {
                    mobileMenu.classList.add('hidden');
                });
            });
        }
    </script>
</body>
</html>
